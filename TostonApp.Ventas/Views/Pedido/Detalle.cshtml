@model TostonApp.Ventas.Models.Pedido
@{
    ViewData["Title"] = "Detalle Pedido";
}

<div class="main-content">
    <h1>Detalle del Pedido #@Model.ID_Pedido</h1>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <div class="card">
        <p><strong>Fecha:</strong> @Model.Fecha.ToString("dd/MM/yyyy HH:mm")</p>
        <p>
            <strong>Cliente:</strong>
            @(Model.Usuario != null
                        ? $"{Model.Usuario.Nombre} {Model.Usuario.Apellido}"
                        : "—")
        </p>
        <p><strong>Cédula:</strong> @(string.IsNullOrWhiteSpace(Model.Cedula) ? "—" : Model.Cedula)</p>
        <p>
            <strong>Estado:</strong>
            <span class="badge @(Model.Estado == "Completado" ? "badge-success" : "badge-warning")">
                @Model.Estado
            </span>
        </p>
        <p><strong>Total:</strong> $@Model.Total.ToString("N2")</p>
        <p><strong>Observaciones:</strong> @(string.IsNullOrWhiteSpace(Model.Observaciones) ? "—" : Model.Observaciones)</p>
    </div>

    <h3>Productos del Pedido</h3>

    <table class="data-table">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Detalles != null && Model.Detalles.Any())
            {
                foreach (var d in Model.Detalles)
                {
                    <tr>
                        <td>@(d.Producto?.Nombre ?? ("ID " + d.ID_Producto))</td>
                        <td>@d.Cantidad</td>
                        <td>$@d.PrecioUnitario.ToString("N2")</td>
                        <td>$@d.Subtotal.ToString("N2")</td>
                    </tr>
                }
            }
            else
            {
                <tr><td colspan="4">Este pedido no tiene productos.</td></tr>
            }
        </tbody>
    </table>

    <div class="form-actions" style="margin-top:16px;">
        <a class="btn-secondary" href="@Url.Action("Index", "Pedido")">Volver</a>

        @* ✅ Botón para generar venta solo si NO está completado *@
        @if (Model.Estado != "Completado" && Model.Detalles != null && Model.Detalles.Any())
        {
            <a class="btn-success"
               href="@Url.Action("CrearDesdePedido", "Venta", new { id = Model.ID_Pedido })">
                Generar Venta
            </a>
        }
    </div>
</div>
